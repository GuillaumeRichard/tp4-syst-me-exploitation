#!/usr/bin/python3
# -*- coding: utf-8 -*-

from protocole import Protocole
from xml.dom.minidom import Document, parseString


class ProtocoleXml(Protocole):
    """Interface du langage de communication XML"""

    def __init__(self):
        super(Protocole, self).__init__()
    pass

    def element_to_xml(self, tag, text=''):
        document = Document()

        texte_a_retourner = document.createElement(tag)
        document.appendChild(texte_a_retourner)
        if text:
            texte_xml = document.createTextNode(text)
            texte_a_retourner.appendChild(texte_xml)

        return document

    def interpret(self, message, parent_tag, child_tag=''):
        document = parseString(message)

        if child_tag:
            return self.interpret_complex_xml(document, parent_tag, child_tag)
        else:
            return self.interpret_simple_xml(document, parent_tag)

    def interpret_simple_xml(self, document, tag_name):
        return document.getElementsByTagName(tag_name)[0].childNodes[0].data

    def interpret_complex_xml(self, document, parent_tag, child_tag):
        data = ''
        for node in document.getElementsByTagName(parent_tag):
            if node is not None:
                for child_node in node.getElementsByTagName(child_tag):
                    data += child_node.firstChild.data + '\n'

        return data

    def get_connexion(self):
        tag = "bonjourServeur"
        document = self.element_to_xml(tag)

        return document.toxml()

    def get_server_name(self):
        tag = "questionNomServeur"
        document = self.element_to_xml(tag)

        return document.toxml()

    def get_folder_list(self, folder_name):
        tag = "questionListeDossiers"
        document = self.element_to_xml(tag, folder_name)

        return document.toxml()

    def get_file_list(self, folder_name):
        tag = "questionListeFichiers"
        document = self.element_to_xml(tag, folder_name)

        return document.toxml()

    def create_folder(self, folder_name):
        tag = "creerDossier"
        document = self.element_to_xml(tag, folder_name)

        return document.toxml()

    def upload_file(self, file_name, folder_name, signature, file_content, date):
        parent_tag = "televerserFichier"
        file_name_tag = "nom"
        folder_name_tag = "dossier"
        siganture_tag = "signature"
        file_content_tag = "contenu"
        date_tag = "date"

        xml_file_name = self.element_to_xml(file_name_tag, file_name)
        xml_folder_name = self.element_to_xml(folder_name_tag, folder_name)
        xml_signature = self.element_to_xml(siganture_tag, signature)
        xml_content = self.element_to_xml(file_content_tag, file_content)
        xml_date = self.element_to_xml(date_tag, date)

        document = self.element_to_xml(parent_tag)

        document.childNodes[0].appendChild(xml_file_name.childNodes[0])
        document.childNodes[0].appendChild(xml_folder_name.childNodes[0])
        document.childNodes[0].appendChild(xml_signature.childNodes[0])
        document.childNodes[0].appendChild(xml_content.childNodes[0])
        document.childNodes[0].appendChild(xml_date.childNodes[0])

        return document.toxml()

    def delete_folder(self, folder_name):
        tag = "supprimerDossier"
        document = self.element_to_xml(tag, folder_name)

        return document.toxml()

    def verify_file_is_identical(self, file_name, folder_name, signature, date):
        parent_tag = "questionFichierIdentique"
        file_name_tag = "nom"
        folder_name_tag = "dossier"
        siganture_tag = "signature"
        date_tag = "date"

        xml_file_name = self.element_to_xml(file_name_tag, file_name)
        xml_folder_name = self.element_to_xml(folder_name_tag, folder_name)
        xml_signature = self.element_to_xml(siganture_tag, signature)
        xml_date = self.element_to_xml(date_tag, date)

        document = self.element_to_xml(parent_tag)

        document.childNodes[0].appendChild(xml_file_name.childNodes[0])
        document.childNodes[0].appendChild(xml_folder_name.childNodes[0])
        document.childNodes[0].appendChild(xml_signature.childNodes[0])
        document.childNodes[0].appendChild(xml_date.childNodes[0])

        return document.toxml()

    def quit(self):
        tag = "quitter"
        document = self.element_to_xml(tag)

        return document.toxml()
