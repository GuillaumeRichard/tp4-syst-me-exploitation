from clientManager import ClientManager
from file_system import FileSystem
from connexion import Connexion
from protocole_xml import ProtocoleXml
import time
import sl4a

class AndroidInterface:
    root = '/mnt/sdcard/dropbox/'
    ipInfo = 'ipInfo.txt'
    fileSystem = FileSystem
    ipInfoContent = ''

    def __init__(self):
        self.fileSystem = FileSystem(self.root)
        folderIsEmpty = self.fileSystem.folder_is_empty(self.root)
        try:
            self.ipInfoContent = self.fileSystem.get_file_content(self.ipInfo)
        except:
            self.ipInfoContent = ''

        if folderIsEmpty == False :
            self.deleteDropboxWindow()
        if self.ipInfoContent == '' :
            self.ipInfoWindow()

        self.updateLoop()

    def deleteDropboxWindow(self):
        title = 'Dropbox'
        message = ('Voulez-vous effacer l\'arboresence '
                   'Dropbox locale existante?')
        droid = sl4a.Android()
        droid.dialogCreateAlert(title, message)
        droid.dialogSetPositiveButtonText('Yes')
        droid.dialogSetNegativeButtonText('No')
        droid.dialogShow()
        response = droid.dialogGetResponse().result

        if response :
            self.fileSystem.clean_local_dropBox()
        elif self.ipInfoContent == '' :
            self.ipInfoWindow()
        else :
            self.updateLoop()

    def ipInfoWindow(self):
        droid = sl4a.Android()
        serveur = droid.dialogGetInput("Veuillez entrer le numéro de serveur svp")
        port = droid.dialogGetInput("Veuillez entrer le numéro de port svp")
        stringInfo = serveur.result + ' ' + port.result #ip + espace + port
        self.fileSystem.write_in_file(self.ipInfo, stringInfo)
        self.ipInfoContent = self.fileSystem.get_file_content(self.ipInfo)
        self.updateLoop()

    def updateLoop(self):
        client = self.create_client()
        title = 'Dropbox'
        message = 'Les fichiers se mettent à jour...'
        droid = sl4a.Android()
        while(True == True):
            droid.dialogCreateSpinnerProgress(title, message)
            droid.dialogShow()

            time.sleep(2)
            droid.dialogDismiss()
            time.sleep(30)

    def create_client(self):
        ipInfo = self.ipInfoContent.split()

        port = ipInfo[0]
        host = ipInfo[1]
        connexion = Connexion(host, port)

        protocol = ProtocoleXml()

        client = ClientManager(connexion, protocol, self.fileSystem)
