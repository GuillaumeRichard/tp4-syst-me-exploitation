from clientManager import ClientManager
from file_system import FileSystem
from connexion import Connexion
from protocole_xml import ProtocoleXml
import time
import sl4a


class AndroidInterface:

    root = '/storage/emulated/0/dropbox'
    ipInfoPath = '/settings/ipInfo.txt'
    fileSystem = FileSystem
    ipInfoContent = ''

    def __init__(self):
        self.fileSystem = FileSystem(self.root)
        folderIsEmpty = self.fileSystem.folder_is_empty('')

        if folderIsEmpty == False :
            self.deleteDropboxWindow()

        try:
            self.ipInfoContent = self.fileSystem.get_file_content(self.ipInfoPath)
        except:
            self.ipInfoContent = ''

        if self.ipInfoContent == '':
            self.ipInfoWindow()
        self.updateLoop()

    def deleteDropboxWindow(self):
        title = 'Dropbox'
        message = ('Voulez-vous effacer l\'arboresence '
                   'Dropbox locale existante?')
        droid = sl4a.Android()
        droid.dialogCreateAlert(title, message)
        droid.dialogSetPositiveButtonText('Oui')
        droid.dialogSetNegativeButtonText('Non')
        droid.dialogShow()
        response = droid.dialogGetResponse().result
        if response['which'] == 'positive':
            self.fileSystem.clean_local_dropBox()

    def ipInfoWindow(self):
        droid = sl4a.Android()
        serveur = droid.dialogGetInput("Informations de connexion", "Addresse IP:")
        port = droid.dialogGetInput("Informations de connexion", "Port:")
        stringInfo = serveur.result + ' ' + port.result #ip + espace + port
        self.fileSystem.write_in_file(self.ipInfoPath, stringInfo)
        self.ipInfoContent = self.fileSystem.get_file_content(self.ipInfoPath)

    def updateLoop(self):
        client = self.create_client()
        title = 'Dropbox'
        message = 'Les fichiers se mettent à jour...'
        droid = sl4a.Android()
        while True == True:
            droid.dialogCreateSpinnerProgress(title, message)
            droid.dialogShow()
            client.update('')
            time.sleep(2)
            droid.dialogDismiss()
            title = 'Dropbox'
            message = 'La mise à jour c\'est complété sans erreurs.'
            droid = sl4a.Android()
            droid.dialogCreateAlert(title, message)
            droid.dialogSetPositiveButtonText('Ok')
            droid.dialogShow()
            time.sleep(300)

    def create_client(self):
        ipInfo = self.ipInfoContent.split()
        host = ipInfo[0]
        port = int(ipInfo[1])
        connexion = Connexion(host, port)
        protocol = ProtocoleXml()
        return ClientManager(connexion, protocol, self.fileSystem)
