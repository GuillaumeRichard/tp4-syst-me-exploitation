from messages import Messages
import os

class Client:
    """
    Classe représentant le client
    """

    def __init__(self, connexion, protocole, file_system):
        self.quit_has_been_called = False

        self.connexion = connexion
        self.protocole = protocole
        self.file_system = file_system

        self.print_welcome_message()
        self.listen_for_input()

    def print_welcome_message(self):
        print(Messages.WELCOME_MESSAGE)

    def listen_for_input(self):
        while True:
            client_input = self.get_client_input()
            self.interpret_input(client_input)

            if self.quit_has_been_called:
                break

    def get_client_input(self):
        return input(Messages.ENTER_COMMAND)

    def interpret_input(self, client_input):
        if client_input == "connecter?":
            self.greeting()
        elif client_input == "nomServeur?":
            self.get_server_name()
        elif "listeDossier?" in client_input:
            self.get_folder_list(client_input)
        elif "dossier?" in client_input:
            self.verify_folder_exists(client_input)
        elif "fichier?" in client_input:
            self.verify_file_exists(client_input)
        elif "creerDossier?" in client_input:
            self.create_folder(client_input)
        elif "televerser?" in client_input:
            self.upload_file(client_input)
        elif "supprimerDossier?" in client_input:
            self.delete_folder(client_input)
        elif client_input == "quitter":
            self.quit()
        else:
            self.print_answer(Messages.BAD_COMMAND)

    def greeting(self):
        message_to_send = self.protocole.get_connexion()
        server_answer = self.get_server_answer(message_to_send)

        if "bonjourClient" in server_answer:
            self.print_answer("Oui")
        else:
            self.print_answer("Non")

    def get_server_name(self):
        tag_name = "nomServeur"

        message_to_send = self.protocole.get_server_name()
        server_answer = self.get_server_answer(message_to_send)
        interpreted_answer = self.protocole.interpret(server_answer, tag_name)
        self.print_answer(interpreted_answer)

    def get_folder_list(self, client_input):
        parent_tag_name = "listeDossiers"
        child_tag_name = "dossier"

        folder_name = self.get_command_argument(client_input)
        message_to_send = self.protocole.get_folder_list(folder_name)
        server_answer = self.get_server_answer(message_to_send)
        interpreted_answer = self.protocole.interpret(server_answer, parent_tag_name, child_tag_name)
        self.print_answer(interpreted_answer)

    def verify_folder_exists(self, client_input):
        folder_name = self.get_command_argument(client_input)
        message_to_send = self.protocole.get_folder_list(folder_name)
        server_answer = self.get_server_answer(message_to_send)

        # si la réponse du serveur ne donne aucune erreur
        if "listeDossiers" in server_answer:
            self.print_answer("Oui")
        else:
            self.print_answer(Messages.ERROR_COMMAND)

    def verify_file_exists(self, client_input):
        path = self.get_command_argument(client_input)
        folder_name = self.get_folder_name(path)

        message_to_send = self.protocole.get_file_list(folder_name)
        server_answer = self.get_server_answer(message_to_send)

        file_name = self.get_file_name(path)
        # si la réponse du serveur ne donne aucune erreur
        if file_name in server_answer:
            self.print_answer("Oui")
        else:
            self.print_answer("Non")

    def create_folder(self, client_input):
        folder_name = self.get_command_argument(client_input)

        message_to_send = self.protocole.create_folder(folder_name)
        server_answer = self.get_server_answer(message_to_send)

        if "ok" in server_answer:
            self.print_answer("Oui")
        else:
            self.print_answer("Non")

    def upload_file(self, client_input):
        path = self.get_command_argument(client_input)
        file_name = self.get_file_name(path)
        folder_name = self.get_folder_name(path)
        signature = self.file_system.get_md5_signature(path)
        file_content = self.file_system.get_encoded_content(path)
        date = self.file_system.get_file_modification_date(path)

        message_to_send = self.protocole.upload_file(file_name, folder_name, signature, file_content, date)
        server_answer = self.get_server_answer(message_to_send)

        if "ok" in server_answer:
            self.print_answer("Ok")
        else:
            self.print_answer(Messages.FILE_NOT_FOUND)

    def delete_folder(self, client_input):
        folder_name = self.get_command_argument(client_input)

        message_to_send = self.protocole.delete_folder(folder_name)
        server_answer = self.get_server_answer(message_to_send)

        if "ok" in server_answer:
            self.print_answer("Ok")
        else:
            self.print_answer(Messages.FILE_NOT_FOUND)

    def quit(self):
        message_to_send = self.protocole.quit()
        server_answer = self.get_server_answer(message_to_send)
        if "bye" in server_answer:
            self.print_answer("Bye")
            self.connexion.close()
            self.quit_has_been_called = True
        else:
            self.print_answer(Messages.ERROR_COMMAND)

    def get_command_argument(self, client_input):
        return client_input.split()[1]

    def get_folder_name(self, path):
        return os.path.dirname(path)

    def get_file_name(self, path):
        return os.path.basename(path)

    def get_server_answer(self, message_to_send):
        self.connexion.send(message_to_send)
        return self.connexion.receive()

    def print_answer(self, answer):
        print(answer)
